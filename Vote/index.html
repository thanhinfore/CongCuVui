<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Ứng dụng khảo sát trực tiếp với Google Forms - Real-time voting visualization">
    <meta name="theme-color" content="#6366f1">

    <title>📊 Live Voting - Real-time Survey Dashboard</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
</head>
<body>
    <div class="container">
        <!-- ================================================================
             SETUP SCREEN
             ================================================================ -->
        <div class="setup-screen" id="setupScreen">
            <div class="setup-card">
                <div class="setup-header">
                    <div class="setup-logo" role="img" aria-label="Survey icon">📊</div>
                    <h1>Khảo sát trực tiếp</h1>
                    <p>Thiết lập nguồn dữ liệu để bắt đầu</p>
                </div>

                <form class="setup-form" id="setupForm" novalidate>
                    <div class="form-group">
                        <label for="formUrl">
                            <span class="label-icon" aria-hidden="true">📝</span>
                            <span>Google Form URL</span>
                            <span class="label-hint">(Link chia sẻ form)</span>
                        </label>
                        <input type="url"
                               id="formUrl"
                               name="formUrl"
                               placeholder="https://docs.google.com/forms/d/e/..."
                               autocomplete="url"
                               spellcheck="false"
                               required
                               aria-describedby="formUrlHint formUrlValidation">
                        <div class="input-hint" id="formUrlHint">
                            Lấy từ: <strong>Send form</strong> → <strong>Copy link</strong>
                        </div>
                        <div class="validation-msg" id="formUrlValidation" role="alert"></div>
                    </div>

                    <div class="form-group">
                        <label for="csvUrl">
                            <span class="label-icon" aria-hidden="true">📊</span>
                            <span>Google Sheets CSV URL</span>
                            <span class="label-hint">(Link dữ liệu responses)</span>
                        </label>
                        <input type="url"
                               id="csvUrl"
                               name="csvUrl"
                               placeholder="https://docs.google.com/spreadsheets/d/e/..."
                               autocomplete="url"
                               spellcheck="false"
                               required
                               aria-describedby="csvUrlHint csvUrlValidation">
                        <div class="input-hint" id="csvUrlHint">
                            Lấy từ: <strong>Responses</strong> → <strong>View in Sheets</strong> → <strong>File</strong> → <strong>Share</strong> → <strong>Publish to web</strong> → Chọn <strong>CSV</strong>
                        </div>
                        <div class="validation-msg" id="csvUrlValidation" role="alert"></div>
                    </div>

                    <button type="button" class="test-btn" id="testConnection" aria-label="Kiểm tra kết nối đến Google Sheets">
                        🔍 Kiểm tra kết nối
                    </button>

                    <button type="submit" class="submit-btn" id="submitBtn">
                        🚀 Bắt đầu khảo sát
                    </button>
                </form>

                <!-- Recent Sessions -->
                <div class="recent-sessions" id="recentSessions">
                    <div class="sessions-header">
                        <h3>📚 Phiên gần đây</h3>
                        <button class="clear-history-btn"
                                id="clearHistory"
                                aria-label="Xóa lịch sử phiên">
                            🗑️ Xóa
                        </button>
                    </div>
                    <div class="sessions-list" id="sessionsList" role="list"></div>
                </div>

                <!-- Quick Guide -->
                <div class="quick-guide">
                    <button class="guide-toggle"
                            id="guideToggle"
                            aria-expanded="false"
                            aria-controls="guideContent">
                        ❓ Hướng dẫn nhanh
                    </button>
                    <div class="guide-content" id="guideContent" aria-hidden="true">
                        <h4>Bước 1: Tạo Google Form</h4>
                        <ol>
                            <li>Tạo form tại <a href="https://forms.google.com" target="_blank" rel="noopener noreferrer">forms.google.com</a></li>
                            <li>Thêm câu hỏi (Multiple choice/Checkboxes)</li>
                            <li>Copy link form từ nút <strong>Send</strong></li>
                        </ol>

                        <h4>Bước 2: Publish Responses</h4>
                        <ol>
                            <li>Mở tab <strong>Responses</strong> trong Form</li>
                            <li>Click icon <strong>View in Sheets</strong> (màu xanh)</li>
                            <li>Trong Sheets: <strong>File</strong> → <strong>Share</strong> → <strong>Publish to web</strong></li>
                            <li>Chọn định dạng <strong>CSV</strong>, click <strong>Publish</strong></li>
                            <li>Copy link CSV được tạo</li>
                        </ol>

                        <h4>Bước 3: Dán vào form trên ⬆️</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================================
             STATISTICS DASHBOARD
             ================================================================ -->
        <div class="stats-dashboard" id="statsDashboard">
            <div class="stats-header">
                <h2>📈 Thống kê phiên khảo sát</h2>
                <button class="back-btn"
                        id="backToSetup"
                        aria-label="Quay lại trang thiết lập">
                    ← Quay lại
                </button>
            </div>
            <div class="stats-grid" id="statsGrid" role="list"></div>
        </div>

        <!-- ================================================================
             LOADING OVERLAY
             ================================================================ -->
        <div class="loading-overlay" id="loadingOverlay" aria-live="polite" aria-busy="true">
            <div class="loading-spinner" role="status" aria-label="Đang tải"></div>
            <div class="loading-text">Đang kiểm tra kết nối...</div>
        </div>

        <!-- ================================================================
             TOAST NOTIFICATIONS
             ================================================================ -->
        <div class="toast-container" id="toastContainer" role="region" aria-live="polite" aria-atomic="true"></div>

        <!-- ================================================================
             ERROR BOX
             ================================================================ -->
        <div class="error-box" id="errorBox" role="alert" aria-live="assertive">
            <div class="error-title">⚠️ Lỗi kết nối dữ liệu</div>
            <div id="errorMessage"></div>
            <div class="error-hint">
                <strong>Gợi ý:</strong> Đảm bảo Google Sheet đã được Publish to Web và link CSV đúng format.
            </div>
            <button class="error-action-btn" id="backToSetupFromError">
                🔧 Quay lại cài đặt
            </button>
        </div>

        <!-- ================================================================
             MAIN APP
             ================================================================ -->
        <div class="main-app" id="mainApp">
            <!-- Header -->
            <header class="header" role="banner">
                <div class="logo">📊 Khảo sát trực tiếp</div>
                <div class="live-indicator" aria-label="Đang cập nhật trực tiếp">
                    <div class="live-dot" aria-hidden="true"></div>
                    <span>LIVE</span>
                </div>
                <div class="header-controls">
                    <div class="stat-badge" aria-label="Tổng số câu hỏi">
                        <span aria-hidden="true">📋</span>
                        <span class="stat-value" id="totalQuestions">0</span>
                        <span>câu</span>
                    </div>
                    <div class="stat-badge" aria-label="Tổng số phản hồi">
                        <span aria-hidden="true">👥</span>
                        <span class="stat-value" id="totalVotes">0</span>
                        <span>phản hồi</span>
                    </div>
                    <div class="stat-badge" aria-label="Thời gian cập nhật gần nhất">
                        <span aria-hidden="true">⏱️</span>
                        <span class="stat-value" id="updateTime">--:--</span>
                    </div>
                    <button class="refresh-btn"
                            id="refreshBtn"
                            aria-label="Làm mới dữ liệu ngay">
                        <span class="refresh-icon" aria-hidden="true">🔄</span>
                    </button>
                    <button class="menu-btn"
                            id="menuBtn"
                            aria-label="Mở menu"
                            aria-expanded="false"
                            aria-controls="dropdownMenu">
                        ⚙️
                    </button>
                </div>
            </header>

            <!-- Dropdown Menu -->
            <nav class="dropdown-menu" id="dropdownMenu" aria-label="Menu chính">
                <button class="menu-item" id="viewStats">📈 Xem thống kê</button>
                <button class="menu-item" id="copyLink">🔗 Copy link</button>
                <button class="menu-item" id="newSession">➕ Phiên mới</button>
            </nav>

            <!-- Floating QR Widget -->
            <aside class="qr-widget" id="qrWidget" aria-label="Mã QR để tham gia khảo sát">
                <div class="qr-widget-header" tabindex="0" role="button" aria-label="Thu gọn/mở rộng mã QR">
                    <span class="qr-widget-title">📱 Quét để tham gia</span>
                    <button class="qr-widget-toggle"
                            aria-label="Thu gọn">
                        −
                    </button>
                </div>
                <div class="qr-widget-body">
                    <div id="qrcode" aria-label="Mã QR liên kết đến form khảo sát"></div>
                    <div class="qr-widget-hint">Hoặc truy cập link trên điện thoại</div>
                </div>
            </aside>

            <!-- Main Layout -->
            <main class="main-layout" role="main">
                <div class="content-area">
                    <!-- View Controls -->
                    <div class="view-controls">
                        <div class="view-tabs" role="tablist" aria-label="Chế độ xem">
                            <button class="view-tab active"
                                    data-view="single"
                                    role="tab"
                                    aria-selected="true"
                                    aria-controls="questionsGrid">
                                Một câu
                            </button>
                            <button class="view-tab"
                                    data-view="all"
                                    role="tab"
                                    aria-selected="false"
                                    aria-controls="questionsGrid">
                                Tất cả
                            </button>
                        </div>
                        <div class="update-indicator" id="updateIndicator" aria-live="polite">
                            <span class="indicator-dot" aria-hidden="true"></span>
                            <span>Đang cập nhật...</span>
                        </div>
                    </div>

                    <!-- Questions Grid -->
                    <div class="questions-grid"
                         id="questionsGrid"
                         role="region"
                         aria-live="polite"
                         aria-atomic="false">
                        <div class="empty-state">
                            <div class="empty-icon" aria-hidden="true">📥</div>
                            <div>Đang tải dữ liệu...</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Application Script -->
    <script src="app.js"></script>
</body>
</html>