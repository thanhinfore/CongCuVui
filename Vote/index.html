<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Live Voting - Enhanced UX</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Setup Screen (shown when no URL params) -->
        <div class="setup-screen" id="setupScreen">
            <div class="setup-card">
                <div class="setup-header">
                    <div class="setup-logo">📊</div>
                    <h1>Khảo sát trực tiếp</h1>
                    <p>Thiết lập nguồn dữ liệu để bắt đầu</p>
                </div>

                <form class="setup-form" id="setupForm">
                    <div class="form-group">
                        <label for="formUrl">
                            <span class="label-icon">📝</span>
                            <span>Google Form URL</span>
                            <span class="label-hint">(Link chia sẻ form)</span>
                        </label>
                        <input type="url"
                               id="formUrl"
                               placeholder="https://docs.google.com/forms/d/e/..."
                               required>
                        <div class="input-hint">
                            Lấy từ: <strong>Send form</strong> → <strong>Copy link</strong>
                        </div>
                        <div class="validation-msg" id="formUrlValidation"></div>
                    </div>

                    <div class="form-group">
                        <label for="csvUrl">
                            <span class="label-icon">📊</span>
                            <span>Google Sheets CSV URL</span>
                            <span class="label-hint">(Link dữ liệu responses)</span>
                        </label>
                        <input type="url"
                               id="csvUrl"
                               placeholder="https://docs.google.com/spreadsheets/d/e/..."
                               required>
                        <div class="input-hint">
                            Lấy từ: <strong>Responses</strong> → <strong>View in Sheets</strong> → <strong>File</strong> → <strong>Share</strong> → <strong>Publish to web</strong> → Chọn <strong>CSV</strong>
                        </div>
                        <div class="validation-msg" id="csvUrlValidation"></div>
                    </div>

                    <button type="button" class="test-btn" id="testConnection">
                        🔍 Kiểm tra kết nối
                    </button>

                    <button type="submit" class="submit-btn" id="submitBtn">
                        🚀 Bắt đầu khảo sát
                    </button>
                </form>

                <!-- Recent Sessions -->
                <div class="recent-sessions" id="recentSessions">
                    <div class="sessions-header">
                        <h3>📚 Phiên gần đây</h3>
                        <button class="clear-history-btn" id="clearHistory">🗑️ Xóa</button>
                    </div>
                    <div class="sessions-list" id="sessionsList"></div>
                </div>

                <!-- Quick Guide -->
                <div class="quick-guide">
                    <button class="guide-toggle" id="guideToggle">❓ Hướng dẫn nhanh</button>
                    <div class="guide-content" id="guideContent">
                        <h4>Bước 1: Tạo Google Form</h4>
                        <ol>
                            <li>Tạo form tại <a href="https://forms.google.com" target="_blank">forms.google.com</a></li>
                            <li>Thêm câu hỏi (Multiple choice/Checkboxes)</li>
                            <li>Copy link form từ nút <strong>Send</strong></li>
                        </ol>

                        <h4>Bước 2: Publish Responses</h4>
                        <ol>
                            <li>Mở tab <strong>Responses</strong> trong Form</li>
                            <li>Click icon <strong>View in Sheets</strong> (màu xanh)</li>
                            <li>Trong Sheets: <strong>File</strong> → <strong>Share</strong> → <strong>Publish to web</strong></li>
                            <li>Chọn định dạng <strong>CSV</strong>, click <strong>Publish</strong></li>
                            <li>Copy link CSV được tạo</li>
                        </ol>

                        <h4>Bước 3: Dán vào form trên ⬆️</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Dashboard -->
        <div class="stats-dashboard" id="statsDashboard">
            <div class="stats-header">
                <h2>📈 Thống kê phiên khảo sát</h2>
                <button class="back-btn" id="backToSetup">← Quay lại</button>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Đang kiểm tra kết nối...</div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Error Box -->
        <div class="error-box" id="errorBox">
            <div class="error-title">⚠️ Lỗi kết nối dữ liệu</div>
            <div id="errorMessage"></div>
            <div class="error-hint">
                <strong>Gợi ý:</strong> Đảm bảo Google Sheet đã được Publish to Web và link CSV đúng format.
            </div>
            <button class="error-action-btn" id="backToSetupFromError">
                🔧 Quay lại cài đặt
            </button>
        </div>

        <!-- Main App (shown when URL params exist) -->
        <div class="main-app" id="mainApp">
            <!-- Header -->
            <div class="header">
                <div class="logo">📊 Khảo sát trực tiếp</div>
                <div class="live-indicator">
                    <div class="live-dot"></div>
                    LIVE
                </div>
                <div class="header-controls">
                    <div class="stat-badge">
                        <span>📋</span>
                        <span class="stat-value" id="totalQuestions">0</span>
                        <span>câu</span>
                    </div>
                    <div class="stat-badge">
                        <span>👥</span>
                        <span class="stat-value" id="totalVotes">0</span>
                        <span>phản hồi</span>
                    </div>
                    <div class="stat-badge">
                        <span>⏱️</span>
                        <span class="stat-value" id="updateTime">--:--</span>
                    </div>
                    <button class="refresh-btn" id="refreshBtn" onclick="app.forceRefresh()">
                        <span class="refresh-icon">🔄</span>
                    </button>
                    <button class="menu-btn" id="menuBtn">⚙️</button>
                </div>
            </div>

            <!-- Dropdown Menu -->
            <div class="dropdown-menu" id="dropdownMenu">
                <button class="menu-item" id="viewStats">📈 Xem thống kê</button>
                <button class="menu-item" id="copyLink">🔗 Copy link</button>
                <button class="menu-item" id="newSession">➕ Phiên mới</button>
            </div>

            <!-- Floating QR Widget -->
            <div class="qr-widget" id="qrWidget">
                <div class="qr-widget-header" onclick="app.toggleQRWidget()">
                    <span class="qr-widget-title">📱 Quét để tham gia</span>
                    <button class="qr-widget-toggle">−</button>
                </div>
                <div class="qr-widget-body">
                    <div id="qrcode"></div>
                    <div class="qr-widget-hint">Hoặc truy cập link trên điện thoại</div>
                </div>
            </div>

            <!-- Main Layout -->
            <div class="main-layout">
                <!-- Content Area Full Width -->
                <div class="content-area">
                    <!-- View Controls -->
                    <div class="view-controls">
                        <div class="view-tabs">
                            <button class="view-tab active" data-view="single">Một câu</button>
                            <button class="view-tab" data-view="all">Tất cả</button>
                        </div>
                        <div class="update-indicator" id="updateIndicator">
                            <span class="indicator-dot"></span>
                            <span>Đang cập nhật...</span>
                        </div>
                    </div>

                    <!-- Questions Grid (2 columns) -->
                    <div class="questions-grid" id="questionsGrid">
                        <div class="empty-state">
                            <div class="empty-icon">📥</div>
                            <div>Đang tải dữ liệu...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>